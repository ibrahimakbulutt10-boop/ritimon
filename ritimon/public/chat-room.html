<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RitimON FM - Ana Sohbet Odasƒ±</title>
    <meta name="description" content="RitimON FM Modern Chat Platformu" />
    <meta name="theme-color" content="#ff4081" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh; color: white; overflow-x: hidden; position: relative;
        }
        .bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 20% 80%, rgba(255, 64, 129, 0.1) 0%, transparent 50%),
                       radial-gradient(circle at 80% 20%, rgba(78, 205, 196, 0.1) 0%, transparent 50%),
                       radial-gradient(circle at 40% 40%, rgba(255, 193, 7, 0.05) 0%, transparent 50%);
        }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9);
            display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(10px); }
        .modal-content { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-radius: 20px; padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.2); text-align: center; max-width: 450px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .modal h2 { font-family: 'Orbitron', monospace; color: #ff4081; margin-bottom: 10px; font-size: 2rem;
            background: linear-gradient(45deg, #ff4081, #ff6ec7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .modal-subtitle { color: #4ecdc4; margin-bottom: 30px; font-size: 1.1rem; opacity: 0.9; }
        .form-group { margin-bottom: 25px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; color: rgba(255, 255, 255, 0.8); font-weight: 500; }
        .form-group input { width: 100%; padding: 15px 20px; border: none; border-radius: 12px; background: rgba(255, 255, 255, 0.1);
            color: white; font-size: 1.1rem; border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease; }
        .form-group input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .form-group input:focus { outline: none; border-color: #ff4081; box-shadow: 0 0 20px rgba(255, 64, 129, 0.3); background: rgba(255,255,255,0.15); }
        .btn-join { width: 100%; padding: 15px 20px; border: none; border-radius: 12px; background: linear-gradient(45deg, #ff4081, #ff6ec7);
            color: white; font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-bottom: 15px; }
        .btn-join:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255, 64, 129, 0.4); }
        .back-link { color: #4ecdc4; text-decoration: none; font-size: 0.9rem; opacity: 0.8; transition: opacity 0.3s ease; }
        .back-link:hover { opacity: 1; }
        .chat-container { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; height: 100vh; position: relative; }
        .chat-header { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-radius: 15px 15px 0 0; padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; gap: 20px; }
        .chat-info h1 { font-family: 'Orbitron', monospace; color: #ff4081; font-size: 1.8rem; margin: 0; }
        .chat-info .subtitle { color: #4ecdc4; font-size: 0.9rem; margin-top: 5px; }
        .user-info { display: flex; align-items: center; gap: 15px; }

        .now-playing-bar { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; text-align: right; }
        .now-playing-top { font-weight: 700; color: #ffc107; }
        .now-playing-detail { color: #4ecdc4; font-size: 0.95rem; }
        .radio-controls { display: flex; align-items: center; gap: 8px; }
        .radio-btn { padding: 6px 10px; border: none; border-radius: 10px; background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; cursor: pointer; }
        .radio-volume { width: 120px; height: 6px; border-radius: 3px; background: rgba(255,255,255,0.2); -webkit-appearance: none; }
        .radio-volume::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: #ff4081; cursor: pointer; }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(45deg, #ff4081, #4ecdc4);
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        .user-name { color: white; font-weight: 600; }
        .chat-main { display: flex; height: calc(100vh - 140px); background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 12px 18px; border-radius: 18px; max-width: 70%; word-wrap: break-word; animation: fadeInUp 0.3s ease; }
        .message.own { align-self: flex-end; background: linear-gradient(45deg, #ff4081, #ff6ec7); color: white; }
        .message.other { align-self: flex-start; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; }
        .message-header { font-size: 0.8rem; opacity: 0.7; margin-bottom: 5px; }
        .users-panel { width: 300px; background: rgba(255,255,255,0.05); border-left: 1px solid rgba(255,255,255,0.1); padding: 20px; }
        .users-title { color: #4ecdc4; font-weight: 600; margin-bottom: 20px; text-align: center; }
        .user-list { display: flex; flex-direction: column; gap: 10px; }
        .user-item { display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; transition: all 0.3s ease; }
        .user-item:hover { background: rgba(255,255,255,0.1); }
        .user-item .avatar { width: 35px; height: 35px; border-radius: 50%; background: linear-gradient(45deg, #4ecdc4, #44a08d);
            display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; }
        .chat-input-container { background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); padding: 20px; border-radius: 0 0 15px 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .format-toolbar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 12px; }
        .format-btn { padding: 8px 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.08); color: white; cursor: pointer; }
        .format-select { padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: white; }
        .emoji-bar { display: grid; grid-template-columns: repeat(auto-fill, minmax(36px, 1fr)); gap: 6px; margin-top: 10px; }
        .emoji-btn { padding: 6px; border: none; border-radius: 8px; background: rgba(255,255,255,0.08); color: white; cursor: pointer; }
        .chat-input-wrapper { display: flex; gap: 15px; align-items: center; }
        .chat-input { flex: 1; padding: 15px 20px; border: none; border-radius: 25px; background: rgba(255,255,255,0.1); color: white; font-size: 1rem; border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease; }
        .chat-input::placeholder { color: rgba(255,255,255,0.5); }
        .chat-input:focus { outline: none; border-color: #ff4081; box-shadow: 0 0 20px rgba(255,64,129,0.3); background: rgba(255,255,255,0.15); }
        .send-btn { padding: 15px 25px; border: none; border-radius: 25px; background: linear-gradient(45deg, #ff4081, #ff6ec7); color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .send-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,64,129,0.4); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }
        @media (max-width: 768px) { .chat-main { flex-direction: column; } .users-panel { width: 100%; max-height: 200px; order: -1; } .message { max-width: 85%; } }
    </style>
</head>
<body>
    <div class="bg-animation"></div>

    <!-- Nickname Modal -->
    <div class="modal" id="nicknameModal">
        <div class="modal-content">
            <h2>RitimON FM</h2>
            <p class="modal-subtitle">Ana Sohbet Odasƒ±na Ho≈ü Geldiniz</p>
            <div class="form-group">
                <label for="nicknameInput">Takma Adƒ±nƒ±z:</label>
                <input type="text" id="nicknameInput" placeholder="Takma adƒ±nƒ±zƒ± girin..." maxlength="20">
            </div>
            <button class="btn-join" onclick="joinChat()">Sohbete Katƒ±l</button>
            <a href="index.html" class="back-link">‚Üê Ana Sayfaya D√∂n</a>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-info">
                <h1>RitimON FM</h1>
                <div class="subtitle">Ana Sohbet Odasƒ±</div>
            </div>
            <div class="now-playing-bar">
                <div class="now-playing-top" id="npTop">üéôÔ∏è Yayƒ±ndaki DJ: <span id="npDJ">Bekleniyor</span></div>
                <div class="now-playing-detail">üéµ ≈ûarkƒ±: <span id="npSong">Y√ºkleniyor...</span></div>
                <div class="radio-controls">
                    <button class="radio-btn" id="radioToggle">‚ñ∂Ô∏è</button>
                    <button class="radio-btn" id="radioMute">üîá</button>
                    <input type="range" class="radio-volume" id="radioVolume" min="0" max="100" value="60" />
                </div>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">?</div>
                <div class="user-name" id="userName">Misafir</div>
            </div>
        </div>
        <div class="chat-main">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="users-panel">
                <div class="users-title">RitimON Dinleyicileri</div>
                <div class="user-list" id="userList"></div>
            </div>
        </div>
        <div class="chat-input-container">
            <div class="format-toolbar">
                <select id="fontSizeSel" class="format-select">
                    <option value="14">K√º√ß√ºk</option>
                    <option value="16" selected>Normal</option>
                    <option value="18">B√ºy√ºk</option>
                    <option value="22">√áok B√ºy√ºk</option>
                </select>
                <button class="format-btn" id="boldBtn">B</button>
                <button class="format-btn" id="italicBtn">I</button>
                <button class="format-btn" id="colorBtn">Renk</button>
            </div>
            <div class="chat-input-wrapper">
                <input type="text" class="chat-input" id="messageInput" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." maxlength="500">
                <button class="send-btn" id="sendBtn">G√∂nder</button>
            </div>
            <div class="emoji-bar" id="emojiBar"></div>
        </div>
    </div>

    <!-- Hidden audio for autoplay stream in chat -->
    <audio id="chatRadio" preload="none" crossorigin="anonymous"></audio>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUser = null;
        const nicknameModal = document.getElementById('nicknameModal');
        const chatContainer = document.getElementById('chatContainer');
        const nicknameInput = document.getElementById('nicknameInput');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatMessages = document.getElementById('chatMessages');
        const userList = document.getElementById('userList');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');

        // Stream sources
        const radioEl = document.getElementById('chatRadio');
        const STREAM_SOURCES = [
            'https://ritimon.radiostream321.com/',
            'https://ritimon.radiostream321.com/stream',
            'https://ritimon.radiostream321.com/;stream/1'
        ];
        let streamIndex = 0;
        let isRadioPlaying = false;
        const radioToggleBtn = document.getElementById('radioToggle');
        const radioMuteBtn = document.getElementById('radioMute');
        const radioVolume = document.getElementById('radioVolume');
        const npDJ = document.getElementById('npDJ');
        const npSong = document.getElementById('npSong');

        async function tryPlayStream() {
            for (let i = 0; i < STREAM_SOURCES.length; i++) {
                const src = STREAM_SOURCES[(streamIndex + i) % STREAM_SOURCES.length];
                try {
                    radioEl.src = src;
                    await radioEl.play();
                    streamIndex = (streamIndex + i) % STREAM_SOURCES.length;
                    isRadioPlaying = true;
                    radioToggleBtn.textContent = '‚è∏Ô∏è';
                    return true;
                } catch (e) {}
            }
            return false;
        }

        async function autoplayRadio() {
            try {
                radioEl.muted = false;
                if (!(await tryPlayStream())) throw new Error('unmuted failed');
            } catch (err) {
                try {
                    radioEl.muted = true;
                    if (await tryPlayStream()) {
                        const firstInteract = () => { radioEl.muted = false; radioEl.play().catch(()=>{}); cleanup(); };
                        const cleanup = () => {
                            document.removeEventListener('click', firstInteract);
                            document.removeEventListener('keydown', firstInteract);
                        };
                        document.addEventListener('click', firstInteract, { once: true });
                        document.addEventListener('keydown', firstInteract, { once: true });
                    }
                } catch(e) {}
            }
        }

        // Radio UI events
        radioToggleBtn.addEventListener('click', async () => {
            if (isRadioPlaying) {
                try { radioEl.pause(); } catch(e){}
                isRadioPlaying = false;
                radioToggleBtn.textContent = '‚ñ∂Ô∏è';
            } else {
                radioEl.volume = Number(radioVolume.value) / 100;
                radioEl.muted = false;
                const ok = await tryPlayStream();
                if (!ok) {
                    radioEl.muted = true;
                    if (await tryPlayStream()) {
                        const firstInteract = () => { radioEl.muted = false; radioEl.play().catch(()=>{}); cleanup(); };
                        const cleanup = () => {
                            document.removeEventListener('click', firstInteract);
                            document.removeEventListener('keydown', firstInteract);
                        };
                        document.addEventListener('click', firstInteract, { once: true });
                        document.addEventListener('keydown', firstInteract, { once: true });
                    }
                }
            }
        });
        radioMuteBtn.addEventListener('click', () => {
            radioEl.muted = !radioEl.muted;
            radioMuteBtn.textContent = radioEl.muted ? 'üîá' : 'üîä';
        });
        radioVolume.addEventListener('input', (e) => {
            try { radioEl.volume = Number(e.target.value) / 100; } catch(e){}
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.joinChat = function() {
            const nickname = nicknameInput.value.trim();
            if (!nickname) { alert('L√ºtfen takma ad girin!'); return; }
            currentUser = { nickname, joinTime: Date.now(), avatar: nickname.charAt(0).toUpperCase() };
            userName.textContent = nickname;
            userAvatar.textContent = currentUser.avatar;
            nicknameModal.style.display = 'none';
            chatContainer.style.display = 'block';
            socket.emit('join', { nickname });
            autoplayRadio();
        };

        function addMessageToUI(data) {
            const isOwn = data.nickname === currentUser?.nickname;
            const wrapper = document.createElement('div');
            wrapper.className = `message ${isOwn ? 'own' : 'other'}`;
            const time = new Date(data.timestamp || Date.now()).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            wrapper.innerHTML = `
                <div class="message-header">${escapeHtml(data.nickname || 'Sistem')} ‚Ä¢ ${time}</div>
                <div>${escapeHtml(data.text || '')}</div>
            `;
            chatMessages.appendChild(wrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(text) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message other';
            wrapper.style.background = 'rgba(78, 205, 196, 0.2)';
            wrapper.style.border = '1px solid rgba(78, 205, 196, 0.3)';
            wrapper.style.textAlign = 'center';
            wrapper.style.fontStyle = 'italic';
            wrapper.innerHTML = `<div>${escapeHtml(text)}</div>`;
            chatMessages.appendChild(wrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function renderUserList(users) {
            userList.innerHTML = '';
            users.forEach(u => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                userDiv.innerHTML = `
                    <div class="avatar">${escapeHtml((u.nickname||'?').charAt(0).toUpperCase())}</div>
                    <div>${escapeHtml(u.nickname||'?')}</div>
                `;
                userList.appendChild(userDiv);
            });
        }

        // Socket events
        socket.on('chat message', (data) => addMessageToUI(data));
        socket.on('userJoined', (u) => addSystemMessage(`üëã ${u.nickname} sohbete katƒ±ldƒ±`));
        socket.on('userLeft', (u) => addSystemMessage(`üëã ${u.nickname} sohbeti terk etti`));
        socket.on('userList', (users) => renderUserList(users));
        socket.on('announcement', (d) => addSystemMessage(`üì¢ ${d.dj}: ${d.text}`));
        socket.on('now playing', (d) => { if (d?.dj) npDJ.textContent = d.dj; if (d?.song) npSong.textContent = d.song; });
        socket.on('userWarned', (d) => addSystemMessage(`‚ö†Ô∏è ${d.targetNickname} uyarƒ±ldƒ± - ${d.reason}`));
        socket.on('userMuted', (d) => addSystemMessage(`üîá ${d.targetNickname} ${d.duration} dk susturuldu - ${d.reason}`));
        socket.on('userBanned', (d) => addSystemMessage(`üö´ ${d.targetNickname} yasaklandƒ± - ${d.reason}`));

        // Emoji bar
        const emojiBar = document.getElementById('emojiBar');
        const emojis = ['üòä','üéµ','‚ù§Ô∏è','üî•','üëç','üëè','üéâ','‚ö°','ü•Å','üéôÔ∏è','üéß','üé∂','üí´','‚≠ê','üíñ','üòé','üòÇ','ü•≥','üôå','üôè'];
        emojis.forEach(em => {
            const b = document.createElement('button'); b.className = 'emoji-btn'; b.textContent = em; b.addEventListener('click',()=>{
                messageInput.value += em; messageInput.focus();
            }); emojiBar.appendChild(b);
        });

        // Formatting
        const fontSizeSel = document.getElementById('fontSizeSel');
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const colorBtn = document.getElementById('colorBtn');
        let isBold = false; let isItalic = false; let color = null;
        fontSizeSel.addEventListener('change', ()=>{ messageInput.style.fontSize = fontSizeSel.value + 'px'; });
        boldBtn.addEventListener('click', ()=>{ isBold = !isBold; messageInput.style.fontWeight = isBold ? '700' : '400'; });
        italicBtn.addEventListener('click', ()=>{ isItalic = !isItalic; messageInput.style.fontStyle = isItalic ? 'italic' : 'normal'; });
        colorBtn.addEventListener('click', ()=>{
            const c = prompt('Mesaj rengi (hex veya isim):', color || '#ffffff');
            if (c) { color = c; messageInput.style.color = color; }
        });

        // Send message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !currentUser) return;
            if (message.length > 500) { alert('Mesaj 500 karakterden uzun olamaz!'); return; }
            const stylePrefix = `${isBold?'**':''}${isItalic?'*':''}`;
            const styled = message; // sunucuya d√ºz metin g√∂nderiyoruz; client formatlƒ±yor
            const msg = { nickname: currentUser.nickname, text: styled, timestamp: new Date().toISOString() };
            socket.emit('chat message', msg);
            messageInput.value = '';
            msg.isOwn = true; addMessageToUI(msg);
            // reset local only styling preview
            messageInput.style.fontWeight = '400'; isBold = false;
            messageInput.style.fontStyle = 'normal'; isItalic = false;
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        nicknameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') joinChat(); });
    </script>
</body>
</html>
