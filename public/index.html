<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RitimON FM</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" />
  <style>
    :root {
      --bg1: #0f0f0f;
      --bg2: #1a1a1a;
      --text: #ffffff;
      --muted: #ffffffcc;
      --accent: #ff4081; /* pink */
      --notice: #ffd166;
      --info: #82eaff;
      --danger: #ef476f;
    }
    .theme-purple { --accent: #a855f7; --bg1: #0c0717; --bg2: #1a1030; }
    .theme-blue { --accent: #3b82f6; --bg1: #06121f; --bg2: #0e2138; }
    .theme-gold { --accent: #f59e0b; --bg1: #19160a; --bg2: #2a230c; }

    body {
      margin: 0;
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(to right, var(--bg1), var(--bg2));
      color: var(--text);
    }
    header {
      text-align: center;
      padding: 20px;
      font-size: 2rem;
      color: var(--accent);
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      padding: 20px;
    }
    .chat-box, .dj-panel, .user-list {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 20px;
      margin: 10px;
      flex: 1 1 400px;
      max-width: 600px;
    }
    #chatMessages {
      height: 300px;
      overflow-y: auto;
      background: #111;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .message-bubble {
      margin-bottom: 8px;
    }
    .nickname {
      font-weight: bold;
      color: var(--accent);
      cursor: pointer;
    }
    .emoji-panel {
      margin-top: 10px;
    }
    .emoji-panel span {
      cursor: pointer;
      font-size: 1.2rem;
      margin: 5px;
    }
    .dj-menu {
      position: absolute;
      background: #222;
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 10px;
      display: none;
      z-index: 999;
    }
    .dj-menu button {
      background: none;
      border: none;
      color: white;
      padding: 5px;
      width: 100%;
      text-align: left;
      cursor: pointer;
    }
    .dj-menu button:hover {
      background: var(--accent);
    }
    @keyframes blink { 50% { opacity: 0.2; } }
    @keyframes neon { 0%, 100% { text-shadow: 0 0 8px var(--accent), 0 0 16px var(--accent);} 50% { text-shadow: 0 0 2px var(--accent), 0 0 4px var(--accent);} }
    @keyframes rotateText { 0% { transform: rotate(0deg); } 50% { transform: rotate(1deg); } 100% { transform: rotate(0deg); } }
    @keyframes marquee { 0% { transform: translateX(100%);} 100% { transform: translateX(-100%);} }
    .accent { color: var(--accent); }
    .btn-primary { background: var(--accent); color: white; border: none; border-radius: 8px; padding: 10px 14px; cursor: pointer; }
    .anim-blink { animation: blink 1.2s steps(2, start) infinite, rotateText 8s linear infinite; }
    .anim-neon { animation: neon 1.2s ease-in-out infinite alternate; }
    #chatMessages img.chat-image { max-width: 100%; display:block; border-radius: 8px; margin-top:6px; object-fit: contain; }
    /* Lightbox */
    #lightboxOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 9999; }
    #lightboxOverlay img { max-width: 95vw; max-height: 95vh; border-radius: 8px; box-shadow: 0 0 24px rgba(0,0,0,0.6); }
  </style>
</head>
<body>
  <header style="display:flex; align-items:center; justify-content:space-between; padding: 20px; gap: 20px; flex-wrap: wrap;">
    <div style="min-width:240px">
      <div style="font-size: 2rem;" class="accent" ><span class="anim-neon">RitimON FM</span></div>
      <div id="slogan" style="color:var(--muted); margin-top:6px; white-space:nowrap; overflow:hidden; position:relative;">
        <span id="sloganText" class="anim-blink" style="display:inline-block; transform-origin:left center;">Listelerde deÄŸil, RUHUNUZDA yankÄ±lanÄ±r</span>
      </div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap: wrap;">
        <button class="btn-primary" data-theme="default">Tema: Pembe</button>
        <button class="btn-primary" data-theme="purple">Mor</button>
        <button class="btn-primary" data-theme="blue">Mavi</button>
        <button class="btn-primary" data-theme="gold">AltÄ±n</button>
      </div>
    </div>
    <div style="text-align:center; flex:1; min-width:260px">
      <div id="nowPlaying" style="margin-bottom:8px;">ğŸ¶ Åu an Ã§alan: YÃ¼kleniyor...</div>
      <div id="onAirDJ" style="font-size:1.1rem; color:#82eaff;">YayÄ±ndaki DJ: -</div>
      <audio id="radioPlayer" controls style="width:100%; max-width: 520px; display:block; margin: 10px auto 0;" src="/radio"></audio>
    </div>
    <div style="min-width:240px; text-align:right;">
      <button id="ctaChat" class="btn-primary">ğŸ’¬ Sohbete GiriÅŸ â€” RitimONâ€™da sohbet</button>
    </div>
  </header>
  <div style="width:100%; overflow:hidden; border-top:1px solid #ffffff1a; border-bottom:1px solid #ffffff1a; padding:8px 0;">
    <div id="djMarquee" style="white-space:nowrap; animation: marquee 18s linear infinite; color:#ffd166;">DJ'ler: -</div>
  </div>
  <div class="container">
    <div class="chat-box">
      <div id="chatMessages"></div>
      <textarea id="chatInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." rows="3" style="width:100%;"></textarea>
      <button onclick="sendMessage()">ğŸ’¬ GÃ¶nder</button>
      <div class="emoji-panel">
        <span>ğŸ˜€</span><span>ğŸ˜‚</span><span>ğŸ˜</span><span>ğŸ˜</span><span>ğŸ˜¢</span><span>ğŸ˜¡</span>
      </div>
    </div>
    <div class="user-list">
      <h3>ğŸ‘¥ KullanÄ±cÄ±lar (<span id="userCount">0</span>)</h3>
      <ul id="users" style="list-style:none; padding-left:0; margin:0;"></ul>
    </div>
    <div class="dj-panel">
      <input type="text" id="nicknameInput" placeholder="Takma adÄ±nÄ±z" />
      <input type="password" id="djPassword" placeholder="DJ ÅŸifresi (opsiyonel)" />
      <button onclick="joinDJ()">ğŸ™ï¸ GiriÅŸ</button>
      <div>
        <h3>ğŸµ ÅarkÄ± YÃ¼kle</h3>
        <div id="dropZone" style="border:2px dashed var(--accent); padding:20px; text-align:center;">DosyayÄ± buraya sÃ¼rÃ¼kleyin</div>
      </div>
      <button id="pushToTalk">ğŸ¤ Bas-KonuÅŸ</button>
      <div style="margin-top:10px; display:flex; gap:6px;">
        <input type="url" id="imageUrl" placeholder="DJ - Resim URL (jpg, png, gif, webp)" style="flex:1;" />
        <button class="btn-primary" id="sendImage">ğŸ–¼ï¸ GÃ¶nder</button>
      </div>
      <input type="text" id="themeUrlInput" placeholder="Tema CSS URL'si" />
      <button onclick="applyTheme()">ğŸ¨ TemayÄ± Uygula</button>
      <button onclick="clearChat()">ğŸ§¹ Sohbeti Temizle</button>
    </div>
  </div>
  <div id="djMenu" class="dj-menu"></div>
  <div id="lightboxOverlay"><img alt="gÃ¶rÃ¼ntÃ¼" src="" /></div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const emojiPanel = document.querySelector('.emoji-panel');
    emojiPanel.addEventListener('click', e => {
      if (e.target.tagName === 'SPAN') {
        document.getElementById('chatInput').value += e.target.textContent;
      }
    });

    function sendMessage() {
      const msg = document.getElementById('chatInput').value;
      const nickname = localStorage.getItem('nickname') || 'Anonim';
      socket.emit('chatMessage', { username: nickname, message: msg });
      document.getElementById('chatInput').value = '';
    }

    socket.on('chatMessage', data => {
      const msgBox = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.innerHTML = `<span class="nickname" data-user="${data.username}">${data.username}</span>: ${data.message}`;
      msgBox.appendChild(bubble);
      msgBox.scrollTop = msgBox.scrollHeight;
    });

    socket.on('chatImage', data => {
      const msgBox = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      // GÃ¶rsel yÃ¼ksekliÄŸini chat kutusunun %80'i ile sÄ±nÄ±rla
      const chatBox = document.getElementById('chatMessages');
      const maxH = Math.floor(chatBox.clientHeight * 0.8);
      bubble.innerHTML = `<span class=\"nickname\" data-user=\"${data.username}\">${data.username}</span> gÃ¶nderdi:<br/><img class=\"chat-image\" src=\"${data.url}\" alt=\"gÃ¶rÃ¼ntÃ¼\" loading=\"lazy\" referrerpolicy=\"no-referrer\" />`;
      const img = bubble.querySelector('img.chat-image');
      img.style.maxHeight = maxH + 'px';
      // Lightbox aÃ§ma
      img.style.cursor = 'zoom-in';
      img.addEventListener('click', () => {
        const overlay = document.getElementById('lightboxOverlay');
        const big = overlay.querySelector('img');
        big.src = img.src;
        overlay.style.display = 'flex';
      });
      msgBox.appendChild(bubble);
      msgBox.scrollTop = msgBox.scrollHeight;
    });

    function joinDJ() {
      const nickname = document.getElementById('nicknameInput').value.trim() || 'Anonim';
      localStorage.setItem('nickname', nickname);
      socket.emit('setNickname', nickname);
      const pass = document.getElementById('djPassword').value.trim();
      if (pass) {
        socket.emit('djLogin', { password: pass }, (res) => {
          if (res && res.ok) {
            localStorage.setItem('isDJ', 'true');
            alert('DJ giriÅŸi baÅŸarÄ±lÄ±');
          } else {
            localStorage.removeItem('isDJ');
            alert('DJ giriÅŸi baÅŸarÄ±sÄ±z');
          }
        });
      }
    }

    function clearChat() {
      if (localStorage.getItem('isDJ') === 'true') {
        socket.emit('clearChat');
      }
    }

    socket.on('clearChat', () => {
      document.getElementById('chatMessages').innerHTML = '';
    });

    socket.on('announcement', (data) => {
      const msgBox = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.style.color = '#ffd166';
      bubble.textContent = `ğŸ“¢ Duyuru: ${data.message}`;
      msgBox.appendChild(bubble);
      msgBox.scrollTop = msgBox.scrollHeight;
    });

    socket.on('userBanned', (username) => {
      const msgBox = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.style.color = '#ef476f';
      bubble.textContent = `ğŸš« ${username} banlandÄ±.`;
      msgBox.appendChild(bubble);
      msgBox.scrollTop = msgBox.scrollHeight;
    });

    function applyTheme() {
      const url = document.getElementById('themeUrlInput').value.trim();
      if (url) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = url;
        document.head.appendChild(link);
      }
    }

    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', e => e.preventDefault());
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      alert(`YÃ¼klenen dosya: ${file.name}`);
    });

    const micButton = document.getElementById('pushToTalk');
    micButton.addEventListener('mousedown', () => console.log('ğŸ¤ YayÄ±n baÅŸladÄ±'));
    micButton.addEventListener('mouseup', () => console.log('ğŸ¤ YayÄ±n durdu'));

    document.getElementById('ctaChat').addEventListener('click', () => {
      const el = document.querySelector('.chat-box');
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Lightbox kapama
    document.getElementById('lightboxOverlay').addEventListener('click', () => {
      const overlay = document.getElementById('lightboxOverlay');
      overlay.style.display = 'none';
      overlay.querySelector('img').src = '';
    });

    // DJ - send image URL to chat
    const sendImageBtn = document.getElementById('sendImage');
    if (sendImageBtn) {
      sendImageBtn.addEventListener('click', () => {
        if (localStorage.getItem('isDJ') !== 'true') { alert('Sadece DJ resim gÃ¶nderebilir'); return; }
        const input = document.getElementById('imageUrl');
        const url = (input.value || '').trim();
        if (!url) return;
        socket.emit('chatImage', { url });
        input.value = '';
      });
    }

    // Theme switcher
    document.querySelectorAll('button[data-theme]').forEach(btn => {
      btn.addEventListener('click', () => {
        const theme = btn.getAttribute('data-theme');
        document.body.classList.remove('theme-purple', 'theme-blue', 'theme-gold');
        if (theme === 'purple') document.body.classList.add('theme-purple');
        if (theme === 'blue') document.body.classList.add('theme-blue');
        if (theme === 'gold') document.body.classList.add('theme-gold');
      });
    });

    document.addEventListener('contextmenu', e => {
      if (e.target.classList.contains('nickname')) {
        e.preventDefault();
        const username = e.target.dataset.user;
        showContextMenu(e.pageX, e.pageY, username);
      }
    });

    function showContextMenu(x, y, username) {
      if (localStorage.getItem('isDJ') !== 'true') return;
      const menu = document.getElementById('djMenu');
      menu.innerHTML = `
        <button onclick="banUser('${username}')">ğŸš« Banla</button>
        <button onclick="clearMessages('${username}')">ğŸ§¹ MesajlarÄ±nÄ± Sil</button>
        <button onclick="assignColor('${username}')">ğŸ¨ Renk Ata</button>
      `;
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.style.display = 'block';
    }

    document.addEventListener('click', () => {
      document.getElementById('djMenu').style.display = 'none';
    });

    function banUser(username) {
      socket.emit('banUser', username);
    }

    function clearMessages(username) {
      const bubbles = document.querySelectorAll('.message-bubble');
      bubbles.forEach(b => {
        if (b.textContent.startsWith(username)) b.remove();
      });
    }

    function assignColor(username) {
      alert(`${username} iÃ§in renk atanacak (Ã¶rnek iÅŸlem)`);
    }
    // User list updates
    socket.emit('setNickname', localStorage.getItem('nickname') || 'Anonim');
    socket.on('userList', (payload) => {
      const list = payload && payload.users ? payload : { users: [], count: 0 };
      const ul = document.getElementById('users');
      ul.innerHTML = '';
      list.users.forEach(u => {
        const li = document.createElement('li');
        li.textContent = u;
        ul.appendChild(li);
      });
      document.getElementById('userCount').textContent = list.count || list.users.length;
    });
    // DJ and marquee updates
    socket.on('djList', (names) => {
      const text = (names && names.length) ? `DJ'ler: ${names.join(' â€¢ ')}` : `DJ'ler: -`;
      const el = document.getElementById('djMarquee');
      if (el) el.textContent = text;
    });
    socket.on('onAir', (name) => {
      const el = document.getElementById('onAirDJ');
      if (el) el.textContent = `YayÄ±ndaki DJ: ${name || '-'}`;
    });

    // Initial fetch for DJs
    fetch('/api/djs').then(r => r.json()).then(({ names }) => {
      const el = document.getElementById('djMarquee');
      if (el && Array.isArray(names)) {
        el.textContent = names.length ? `DJ'ler: ${names.join(' â€¢ ')}` : `DJ'ler: -`;
      }
    }).catch(() => {});
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }
    // Reuse existing socket
    socket.on('currentSong', (song) => {
      document.getElementById('nowPlaying').textContent = 'ğŸ¶ Åu an Ã§alan: ' + song;
    });
  </script>
  
</body>
</html>

