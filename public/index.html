<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RitimON FM</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" />
  <style>
    body {
      margin: 0;
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(to right, #0f0f0f, #1a1a1a);
      color: white;
    }
    header {
      text-align: center;
      padding: 20px;
      font-size: 2rem;
      color: #ff4081;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      padding: 20px;
    }
    .chat-box, .dj-panel, .user-list {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 20px;
      margin: 10px;
      flex: 1 1 400px;
      max-width: 600px;
    }
    #chatMessages {
      height: 300px;
      overflow-y: auto;
      background: #111;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .message-bubble {
      margin-bottom: 8px;
    }
    .nickname {
      font-weight: bold;
      color: #ff4081;
      cursor: pointer;
    }
    .emoji-panel {
      margin-top: 10px;
    }
    .emoji-panel span {
      cursor: pointer;
      font-size: 1.2rem;
      margin: 5px;
    }
    .dj-menu {
      position: absolute;
      background: #222;
      border: 1px solid #ff4081;
      border-radius: 8px;
      padding: 10px;
      display: none;
      z-index: 999;
    }
    .dj-menu button {
      background: none;
      border: none;
      color: white;
      padding: 5px;
      width: 100%;
      text-align: left;
      cursor: pointer;
    }
    .dj-menu button:hover {
      background: #ff4081;
    }
    @keyframes blink { 50% { opacity: 0.2; } }
    @keyframes rotateText { 0% { transform: rotate(0deg); } 50% { transform: rotate(1deg); } 100% { transform: rotate(0deg); } }
    @keyframes marquee { 0% { transform: translateX(100%);} 100% { transform: translateX(-100%);} }
  </style>
</head>
<body>
  <header style="display:flex; align-items:center; justify-content:space-between; padding: 20px; gap: 20px; flex-wrap: wrap;">
    <div style="min-width:240px">
      <div style="font-size: 2rem; color:#ff4081; font-weight:700;">RitimON FM</div>
      <div id="slogan" style="color:#ffffffcc; margin-top:6px; white-space:nowrap; overflow:hidden; position:relative;">
        <span id="sloganText" style="display:inline-block; animation: blink 1.2s steps(2, start) infinite, rotateText 8s linear infinite; transform-origin:left center;">Listelerde değil, RUHUNUZDA yankılanır</span>
      </div>
    </div>
    <div style="text-align:center; flex:1; min-width:260px">
      <div id="nowPlaying" style="margin-bottom:8px;">🎶 Şu an çalan: Yükleniyor...</div>
      <div id="onAirDJ" style="font-size:1.1rem; color:#82eaff;">Yayındaki DJ: -</div>
      <audio id="radioPlayer" controls style="width:100%; max-width: 520px; display:block; margin: 10px auto 0;" src="/radio"></audio>
    </div>
    <div style="min-width:240px; text-align:right;">
      <button id="ctaChat" style="background:#ff4081; color:white; border:none; border-radius:8px; padding:10px 14px; cursor:pointer;">💬 Sohbete Giriş — RitimON’da sohbet</button>
    </div>
  </header>
  <div style="width:100%; overflow:hidden; border-top:1px solid #ffffff1a; border-bottom:1px solid #ffffff1a; padding:8px 0;">
    <div id="djMarquee" style="white-space:nowrap; animation: marquee 18s linear infinite; color:#ffd166;">DJ'ler: -</div>
  </div>
  <div class="container">
    <div class="chat-box">
      <div id="chatMessages"></div>
      <textarea id="chatInput" placeholder="Mesajınızı yazın..." rows="3" style="width:100%;"></textarea>
      <button onclick="sendMessage()">💬 Gönder</button>
      <div class="emoji-panel">
        <span>😀</span><span>😂</span><span>😍</span><span>😎</span><span>😢</span><span>😡</span>
      </div>
    </div>
    <div class="user-list">
      <h3>👥 Kullanıcılar (<span id="userCount">0</span>)</h3>
      <ul id="users" style="list-style:none; padding-left:0; margin:0;"></ul>
    </div>
    <div class="dj-panel">
      <input type="text" id="nicknameInput" placeholder="Takma adınız" />
      <input type="password" id="djPassword" placeholder="DJ şifresi (opsiyonel)" />
      <button onclick="joinDJ()">🎙️ Giriş</button>
      <div>
        <h3>🎵 Şarkı Yükle</h3>
        <div id="dropZone" style="border:2px dashed #ff4081; padding:20px; text-align:center;">Dosyayı buraya sürükleyin</div>
      </div>
      <button id="pushToTalk">🎤 Bas-Konuş</button>
      <input type="text" id="themeUrlInput" placeholder="Tema CSS URL'si" />
      <button onclick="applyTheme()">🎨 Temayı Uygula</button>
      <button onclick="clearChat()">🧹 Sohbeti Temizle</button>
    </div>
  </div>
  <div id="djMenu" class="dj-menu"></div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const emojiPanel = document.querySelector('.emoji-panel');
    emojiPanel.addEventListener('click', e => {
      if (e.target.tagName === 'SPAN') {
        document.getElementById('chatInput').value += e.target.textContent;
      }
    });

    function sendMessage() {
      const msg = document.getElementById('chatInput').value;
      const nickname = localStorage.getItem('nickname') || 'Anonim';
      socket.emit('chatMessage', { username: nickname, message: msg });
      document.getElementById('chatInput').value = '';
    }

    socket.on('chatMessage', data => {
      const msgBox = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.innerHTML = `<span class="nickname" data-user="${data.username}">${data.username}</span>: ${data.message}`;
      msgBox.appendChild(bubble);
      msgBox.scrollTop = msgBox.scrollHeight;
    });

    function joinDJ() {
      const nickname = document.getElementById('nicknameInput').value.trim() || 'Anonim';
      localStorage.setItem('nickname', nickname);
      socket.emit('setNickname', nickname);
      const pass = document.getElementById('djPassword').value.trim();
      if (pass) {
        socket.emit('djLogin', { password: pass }, (res) => {
          if (res && res.ok) {
            localStorage.setItem('isDJ', 'true');
            alert('DJ girişi başarılı');
          } else {
            localStorage.removeItem('isDJ');
            alert('DJ girişi başarısız');
          }
        });
      }
    }

    function clearChat() {
      if (localStorage.getItem('isDJ') === 'true') {
        socket.emit('clearChat');
      }
    }

    socket.on('clearChat', () => {
      document.getElementById('chatMessages').innerHTML = '';
    });

    socket.on('announcement', (data) => {
      const msgBox = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.style.color = '#ffd166';
      bubble.textContent = `📢 Duyuru: ${data.message}`;
      msgBox.appendChild(bubble);
      msgBox.scrollTop = msgBox.scrollHeight;
    });

    socket.on('userBanned', (username) => {
      const msgBox = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.style.color = '#ef476f';
      bubble.textContent = `🚫 ${username} banlandı.`;
      msgBox.appendChild(bubble);
      msgBox.scrollTop = msgBox.scrollHeight;
    });

    function applyTheme() {
      const url = document.getElementById('themeUrlInput').value.trim();
      if (url) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = url;
        document.head.appendChild(link);
      }
    }

    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', e => e.preventDefault());
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      alert(`Yüklenen dosya: ${file.name}`);
    });

    const micButton = document.getElementById('pushToTalk');
    micButton.addEventListener('mousedown', () => console.log('🎤 Yayın başladı'));
    micButton.addEventListener('mouseup', () => console.log('🎤 Yayın durdu'));

    document.getElementById('ctaChat').addEventListener('click', () => {
      const el = document.querySelector('.chat-box');
      if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    document.addEventListener('contextmenu', e => {
      if (e.target.classList.contains('nickname')) {
        e.preventDefault();
        const username = e.target.dataset.user;
        showContextMenu(e.pageX, e.pageY, username);
      }
    });

    function showContextMenu(x, y, username) {
      if (localStorage.getItem('isDJ') !== 'true') return;
      const menu = document.getElementById('djMenu');
      menu.innerHTML = `
        <button onclick="banUser('${username}')">🚫 Banla</button>
        <button onclick="clearMessages('${username}')">🧹 Mesajlarını Sil</button>
        <button onclick="assignColor('${username}')">🎨 Renk Ata</button>
      `;
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.style.display = 'block';
    }

    document.addEventListener('click', () => {
      document.getElementById('djMenu').style.display = 'none';
    });

    function banUser(username) {
      socket.emit('banUser', username);
    }

    function clearMessages(username) {
      const bubbles = document.querySelectorAll('.message-bubble');
      bubbles.forEach(b => {
        if (b.textContent.startsWith(username)) b.remove();
      });
    }

    function assignColor(username) {
      alert(`${username} için renk atanacak (örnek işlem)`);
    }
    // User list updates
    socket.emit('setNickname', localStorage.getItem('nickname') || 'Anonim');
    socket.on('userList', (payload) => {
      const list = payload && payload.users ? payload : { users: [], count: 0 };
      const ul = document.getElementById('users');
      ul.innerHTML = '';
      list.users.forEach(u => {
        const li = document.createElement('li');
        li.textContent = u;
        ul.appendChild(li);
      });
      document.getElementById('userCount').textContent = list.count || list.users.length;
    });
    // DJ and marquee updates
    socket.on('djList', (names) => {
      const text = (names && names.length) ? `DJ'ler: ${names.join(' • ')}` : `DJ'ler: -`;
      const el = document.getElementById('djMarquee');
      if (el) el.textContent = text;
    });
    socket.on('onAir', (name) => {
      const el = document.getElementById('onAirDJ');
      if (el) el.textContent = `Yayındaki DJ: ${name || '-'}`;
    });

    // Initial fetch for DJs
    fetch('/api/djs').then(r => r.json()).then(({ names }) => {
      const el = document.getElementById('djMarquee');
      if (el && Array.isArray(names)) {
        el.textContent = names.length ? `DJ'ler: ${names.join(' • ')}` : `DJ'ler: -`;
      }
    }).catch(() => {});
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }
    // Reuse existing socket
    socket.on('currentSong', (song) => {
      document.getElementById('nowPlaying').textContent = '🎶 Şu an çalan: ' + song;
    });
  </script>
  
</body>
</html>

