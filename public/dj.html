<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RitimON FM</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" />
  <style>
    :root { --accent:#ff4081; --muted:#ffffffb3; }
    body { margin:0; font-family:'Orbitron',sans-serif; background:linear-gradient(to right,#0f0f0f,#1a1a1a); color:#fff; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px; }
    .brand { font-size:1.8rem; color:var(--accent); }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    .btn { background:var(--accent); color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; text-decoration:none; }
    .btn.listen { background:#3b82f6; }
    .muted { color:var(--muted); font-size:.9rem; }
    .links { text-align:right; font-size:.9rem; }
    .links a { color:#9ad0ff; text-decoration:none; }
    .container { display:flex; flex-wrap:wrap; gap:16px; padding:16px; }
    .panel { background:rgba(255,255,255,.06); border-radius:10px; padding:16px; flex:1 1 380px; max-width:640px; }
    #chatMessages { height:380px; overflow-y:auto; background:#111; padding:10px; border-radius:8px; margin-bottom:10px; }
    .message-bubble { margin-bottom:8px; }
    .nickname { font-weight:700; color:var(--accent); cursor:pointer; }
    .emoji-panel { margin-top:10px; border:1px solid #ffffff33; border-radius:8px; padding:8px; }
    .emoji-panel span { cursor:pointer; font-size:1.6rem; margin:4px; display:inline-block; }
    .user-list ul { list-style:none; padding:0; margin:0; }
    .dj-menu { position:absolute; background:#222; border:1px solid var(--accent); border-radius:8px; padding:10px; display:none; z-index:999; }
    .dj-menu button { background:none; border:none; color:#fff; padding:5px; width:100%; text-align:left; cursor:pointer; }
    .dj-menu button:hover { background:var(--accent); }
    /* Join overlay */
    .join-overlay { position:fixed; inset:0; background:rgba(0,0,0,.75); display:none; align-items:center; justify-content:center; z-index:1000; }
    .join-card { background:#141414; border:1px solid #ffffff22; border-radius:12px; padding:16px; width:95%; max-width:360px; text-align:center; }
    .join-card input { width:100%; padding:10px; border-radius:8px; border:1px solid #ffffff33; background:#0f0f0f; color:#fff; }
  </style>
</head>
<body>
  <header>
    <div class="brand">🎧 RitimON FM</div>
    <div class="toolbar">
      <button id="btnJoinOpen" class="btn">💬 Sohbete Giriş</button>
      <a class="btn listen" href="https://ritimon.radio12345.com" target="_blank">▶ Dinlemek için tıkla</a>
    </div>
    <div class="links">
      <div class="muted">Dinleme yalnızca bu bağlantılardan yapılır:</div>
      <div><a href="https://ritimon.radio12345.com" target="_blank">ritimon.radio12345.com</a></div>
      <div><a href="https://ritimon.radiostream321.com" target="_blank">ritimon.radiostream321.com</a></div>
      <div><a href="https://ritimon.radiostream123.com" target="_blank">ritimon.radiostream123.com</a></div>
    </div>
  </header>

  <div style="padding:0 16px; margin-bottom:6px;">
    <div id="nowPlaying">🎶 Şu an çalan: Yükleniyor...</div>
  </div>

  <div class="container">
    <div class="panel" id="chatPanel">
      <div id="chatMessages"></div>
      <textarea id="chatInput" placeholder="Mesajınızı yazın..." rows="3" style="width:100%;"></textarea>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="btnSend" class="btn">💬 Gönder</button>
        <button id="btnClear" class="btn" style="background:#8b5cf6;">🧹 Sohbeti Temizle (DJ)</button>
      </div>
      <div class="emoji-panel" id="emojiPanel">
        <span>😀</span><span>😂</span><span>😍</span><span>😎</span><span>😢</span><span>😡</span><span>🔥</span><span>🎵</span>
      </div>
    </div>

    <div class="panel user-list">
      <h3>👥 Kullanıcılar (<span id="userCount">0</span>)</h3>
      <ul id="users"></ul>
      <div style="margin-top:12px;">
        <a class="btn" href="/dj.html">🎙️ DJ Paneli</a>
        <a class="btn" href="/blog.html" style="background:#10b981">📝 Blog</a>
        <a class="btn" href="/gallery.html" style="background:#f59e0b">🖼️ Galeri</a>
      </div>
    </div>
  </div>

  <div id="djMenu" class="dj-menu"></div>

  <!-- Join overlay -->
  <div id="joinOverlay" class="join-overlay">
    <div class="join-card">
      <h3>💬 Sohbete Katıl</h3>
      <input type="text" id="nickInput" placeholder="Takma adınız" />
      <div style="display:flex; gap:8px; justify-content:center; margin-top:10px;">
        <button id="btnJoin" class="btn">Giriş</button>
        <button id="btnJoinCancel" class="btn" style="background:#6b7280">İptal</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const state = { nickname: sessionStorage.getItem('nickname') || '' };

    // Show/hide join
    const joinOverlay = document.getElementById('joinOverlay');
    function requireJoin() { joinOverlay.style.display = 'flex'; }
    function hideJoin() { joinOverlay.style.display = 'none'; }
    document.getElementById('btnJoinOpen').onclick = requireJoin;
    document.getElementById('btnJoinCancel').onclick = hideJoin;
    document.getElementById('btnJoin').onclick = () => {
      const n = (document.getElementById('nickInput').value || '').trim();
      if (!n) return;
      state.nickname = n;
      sessionStorage.setItem('nickname', n);
      socket.emit('setNickname', n);
      hideJoin();
    };
    // if no nick, block reading chat
    let canSeeChat = !!state.nickname;
    if (!canSeeChat) requireJoin();

    // Emoji add only to input
    document.getElementById('emojiPanel').addEventListener('click', e => {
      if (e.target.tagName === 'SPAN') {
        const area = document.getElementById('chatInput');
        area.value += e.target.textContent;
        area.focus();
      }
    });

    function sendMessage() {
      if (!state.nickname) { requireJoin(); return; }
      const msg = document.getElementById('chatInput').value.trim();
      if (!msg) return;
      socket.emit('chatMessage', { username: state.nickname, message: msg });
      document.getElementById('chatInput').value = '';
    }
    document.getElementById('btnSend').onclick = sendMessage;
    document.getElementById('chatInput').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    // Clear chat (DJ only; server doğrular)
    document.getElementById('btnClear').onclick = () => socket.emit('clearChat');

    // Incoming
    socket.on('chatMessage', data => {
      if (!state.nickname) return; // dışarıdan görülemesin
      const msgBox = document.getElementById('chatMessages');
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.innerHTML = `<span class="nickname" data-user="${data.username}">${data.username}</span>: ${data.message}`;
      msgBox.appendChild(bubble);
      msgBox.scrollTop = msgBox.scrollHeight;
    });
    socket.on('clearChat', () => { document.getElementById('chatMessages').innerHTML = ''; });

    // User list
    if (state.nickname) socket.emit('setNickname', state.nickname);
    socket.on('userList', (payload) => {
      const list = payload && payload.users ? payload : { users: [], count: 0 };
      const ul = document.getElementById('users'); ul.innerHTML = '';
      list.users.forEach(u => {
        const li = document.createElement('li');
        li.textContent = u;
        ul.appendChild(li);
      });
      document.getElementById('userCount').textContent = list.count || list.users.length;
    });

    // Context menu (DJ only; server yetki kontrol eder)
    document.addEventListener('contextmenu', e => {
      if (e.target.classList.contains('nickname')) {
        e.preventDefault();
        const username = e.target.dataset.user;
        const menu = document.getElementById('djMenu');
        menu.innerHTML = `
          <button onclick="banUser('${username}')">🚫 Banla</button>
          <button onclick="clearMessages('${username}')">🧹 Mesajlarını Sil</button>
        `;
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        menu.style.display = 'block';
      }
    });
    document.addEventListener('click', () => { document.getElementById('djMenu').style.display = 'none'; });
    function banUser(username){ socket.emit('banUser', username); }
    function clearMessages(username){
      document.querySelectorAll('.message-bubble').forEach(b => {
        if (b.textContent.startsWith(username)) b.remove();
      });
    }

    // Now playing
    socket.on('currentSong', (song) => {
      document.getElementById('nowPlaying').textContent = '🎶 Şu an çalan: ' + song;
    });

    // SW
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }
  </script>
</body>
</html>
